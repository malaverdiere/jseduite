<?xml version="1.0" encoding="UTF-8"?>
<!--
This file is part of jSeduite::InfoProvider

Copyright (C) 2008-  Sebastien Mosser

jSeduite::InfoProvider is free software; you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation; either version 2 of the License, or
(at your option) any later version.

jSeduite::InfoProvider is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with jSeduite::InfoProvider; if not, write to the Free Software
Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA

@author      Main Sébastien Mosser          [mosser@polytech.unice.fr]
@contributor 2008 Clémentine Delerce-Mauris [delercm@polytech.unice.fr]
@contributor 2008 Lionel Palacin            [lionel.palacin@gmail.com]
@contributor 2008 Stéphane Martarello       [stephane.martarello@gmail.com]
-->
<process
    name="InfoProvider"
    targetNamespace="http://modalis.polytech.unice.fr/jSeduite/bpel/InfoProvider/epu"
    xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema"
    xmlns:sxt="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Trace" 
    xmlns:sxed="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Editor"
    xmlns:tns="http://modalis.polytech.unice.fr/jSeduite/bpel/InfoProvider/epu"
    xmlns:ns0="http://modalis.polytech.unice.fr/jSeduite/schema/InfoProvider/epu" xmlns:ns1="http://modalis.i3s.unice.fr/jSeduite/schema/CachedFeedReader" xmlns:ns2="http://preferences.technical.jSeduite.modalis.i3s.unice.fr/" xmlns:ns3="http://docs.oasis-open.org/wsbpel/2.0/process/executable" xmlns:sxxf="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/XPathFunctions" xmlns:ns4="http://modalis.i3s.unice.fr/jSeduite/schema/TvShows">
    <import namespace="http://modalis.polytech.unice.fr/jSeduite/wsdl/InfoProvider/epu" location="InfoProvider.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://modalis.polytech.unice.fr/jSeduite/schema/InfoProvider/epu" location="InfoProvider.xsd" importType="http://www.w3.org/2001/XMLSchema"/>
    <import namespace="http://enterprise.netbeans.org/bpel/ErrorLoggerServiceWrapper" location="TechPartners/ErrorLoggerServiceWrapper.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://error.logger.technical.jSeduite.modalis.i3s.unice.fr/" location="TechPartners/ErrorLoggerService.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://enterprise.netbeans.org/bpel/AccountManagerServiceWrapper" location="TechPartners/AccountManagerServiceWrapper.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://accounts.technical.jSeduite.modalis.i3s.unice.fr/" location="TechPartners/AccountManagerService.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://enterprise.netbeans.org/bpel/PreferenceManagerServiceWrapper" location="TechPartners/PreferenceManagerServiceWrapper.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://preferences.technical.jSeduite.modalis.i3s.unice.fr/" location="TechPartners/PreferenceManagerService.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://modalis.i3s.unice.fr/jSeduite/wsdl/CachedFeedReader" location="Sources/CachedFeedReader.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://enterprise.netbeans.org/bpel/ICalReaderServiceWrapper" location="Sources/ICalReaderServiceWrapper.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://calendar.technical.jSeduite.modalis.i3s.unice.fr/" location="Sources/ICalReaderService.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://enterprise.netbeans.org/bpel/TimeMachineServiceWrapper" location="TechPartners/TimeMachineServiceWrapper.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://time.helpers.technical.jSeduite.modails.i3s.unice.fr/" location="TechPartners/TimeMachineService.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://modalis.i3s.unice.fr/jSeduite/wsdl/TvShows" location="Sources/TvShows.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <partnerLinks>
        <partnerLink name="accounts" xmlns:tns="http://enterprise.netbeans.org/bpel/AccountManagerServiceWrapper" partnerLinkType="tns:AccountManagerLinkType" partnerRole="accounts"/>
        <partnerLink name="preferences" xmlns:tns="http://enterprise.netbeans.org/bpel/PreferenceManagerServiceWrapper" partnerLinkType="tns:PreferenceManagerLinkType" partnerRole="preferences"/>
        <partnerLink name="logger" xmlns:tns="http://enterprise.netbeans.org/bpel/ErrorLoggerServiceWrapper" partnerLinkType="tns:ErrorLoggerLinkType" partnerRole="logger"/>
        <partnerLink name="time" xmlns:tns="http://enterprise.netbeans.org/bpel/TimeMachineServiceWrapper" partnerLinkType="tns:TimeMachineLinkType" partnerRole="time"/>
        <partnerLink name="feedreader" xmlns:tns="http://modalis.i3s.unice.fr/jSeduite/wsdl/CachedFeedReader" partnerLinkType="tns:CachedFeedReader" partnerRole="CachedFeedReaderPortTypeRole"/>
        <partnerLink name="iCal" xmlns:tns="http://enterprise.netbeans.org/bpel/ICalReaderServiceWrapper" partnerLinkType="tns:ICalReaderLinkType" partnerRole="iCal"/>
        <partnerLink name="tv" xmlns:tns="http://modalis.i3s.unice.fr/jSeduite/wsdl/TvShows" partnerLinkType="tns:TvShows" partnerRole="TvShowsPortTypeRole"/>
        <partnerLink name="external" xmlns:tns="http://modalis.polytech.unice.fr/jSeduite/wsdl/InfoProvider/epu" partnerLinkType="tns:InfoProvider" myRole="InfoProviderPortTypeRole"/>
    </partnerLinks>
    <variables>
        <variable name="tvShows" type="ns0:ShowSet"/>
        <variable name="ical_result" type="ns0:CalendatEventSet"/>
        <variable name="globalIndex" type="xsd:integer"/>
        <variable name="feed_reader_result" type="ns0:FeedContentSet"/>
        <variable name="IsAuthorizedOut" xmlns:tns="http://accounts.technical.jSeduite.modalis.i3s.unice.fr/" messageType="tns:isAuthorizedResponse"/>
        <variable name="IsAuthorizedIn" xmlns:tns="http://accounts.technical.jSeduite.modalis.i3s.unice.fr/" messageType="tns:isAuthorized"/>
        <variable name="authorized" type="xsd:boolean"/>
        <variable name="result" type="ns0:InformationSet"/>
        <variable name="password" type="xsd:string"/>
        <variable name="user" type="xsd:string"/>
        <variable name="GetInformationOut" xmlns:tns="http://modalis.polytech.unice.fr/jSeduite/wsdl/InfoProvider/epu" messageType="tns:GetInformationResponse"/>
        <variable name="GetInformationIn" xmlns:tns="http://modalis.polytech.unice.fr/jSeduite/wsdl/InfoProvider/epu" messageType="tns:GetInformationRequest"/>
    </variables>
    <sequence>
        <sequence name="reception">
            <receive name="receive" createInstance="yes" partnerLink="external" operation="GetInformation" xmlns:tns="http://modalis.polytech.unice.fr/jSeduite/wsdl/InfoProvider/epu" portType="tns:InfoProviderPortType" variable="GetInformationIn"/>
            <assign name="feed_vars">
                <documentation>literal assignment looks weird using netbeans bpel runtime</documentation>
                <copy>
                    <from>$GetInformationIn.in/ns0:user</from>
                    <to variable="user"/>
                </copy>
                <copy>
                    <from>$GetInformationIn.in/ns0:password</from>
                    <to variable="password"/>
                </copy>
            </assign>
        </sequence>
        <sequence name="authentication">
            <assign name="authentication_pre">
                <copy>
                    <from variable="user"/>
                    <to>$IsAuthorizedIn.parameters/login</to>
                </copy>
                <copy>
                    <from variable="password"/>
                    <to>$IsAuthorizedIn.parameters/password</to>
                </copy>
            </assign>
            <invoke name="authentication_tech" partnerLink="accounts" operation="isAuthorized" xmlns:tns="http://accounts.technical.jSeduite.modalis.i3s.unice.fr/" portType="tns:AccountManager" inputVariable="IsAuthorizedIn" outputVariable="IsAuthorizedOut"/>
            <assign name="authentication_post">
                <copy>
                    <from>$IsAuthorizedOut.parameters/return</from>
                    <to variable="authorized"/>
                </copy>
            </assign>
        </sequence>
        <if name="canAccess">
            <condition>$authorized</condition>
            <empty name="nop"/>
            <else>
                <sequence name="unauthorized">
                        <throw name="throw" faultName="ns3:invalidVariables"/>
                        <exit name="Exit1"/>
                </sequence>
            </else>
        </if>
        <flow name="source_invocations">
            <scope name="CachedFeedReader">
                <variables>
                    <variable name="LogOut" xmlns:tns="http://error.logger.technical.jSeduite.modalis.i3s.unice.fr/" messageType="tns:logResponse"/>
                    <variable name="LogIn" xmlns:tns="http://error.logger.technical.jSeduite.modalis.i3s.unice.fr/" messageType="tns:log"/>
                    <variable name="GetParameterValueOut" xmlns:tns="http://preferences.technical.jSeduite.modalis.i3s.unice.fr/" messageType="tns:getParameterValueResponse"/>
                    <variable name="GetParameterValueIn" xmlns:tns="http://preferences.technical.jSeduite.modalis.i3s.unice.fr/" messageType="tns:getParameterValue"/>
                    <variable name="CachedFeedReaderOperationOut" xmlns:tns="http://modalis.i3s.unice.fr/jSeduite/wsdl/CachedFeedReader" messageType="tns:CachedFeedReaderOperationResponse"/>
                    <variable name="CachedFeedReaderOperationIn" xmlns:tns="http://modalis.i3s.unice.fr/jSeduite/wsdl/CachedFeedReader" messageType="tns:CachedFeedReaderOperationRequest"/>
                    <variable name="cpt" type="xsd:integer"/>
                    <variable name="GetCallIdentifiersOut" xmlns:tns="http://preferences.technical.jSeduite.modalis.i3s.unice.fr/" messageType="tns:getCallIdentifiersResponse"/>
                    <variable name="GetCallIdentifiersIn" xmlns:tns="http://preferences.technical.jSeduite.modalis.i3s.unice.fr/" messageType="tns:getCallIdentifiers"/>
                </variables>
                <faultHandlers>
                    <catchAll>
                        <sequence name="onError">
                            <sequence name="log">
                                <assign name="log_pre">
                                    <copy>
                                        <from>'InfoProvider'</from>
                                        <to>$LogIn.parameters/trigger</to>
                                    </copy>
                                    <copy>
                                        <from>'exception'</from>
                                        <to>$LogIn.parameters/level</to>
                                    </copy>
                                    <copy>
                                        <from>'CachedRssReader Source Exception'</from>
                                        <to>$LogIn.parameters/message</to>
                                    </copy>
                                </assign>
                                <invoke name="log_tech" partnerLink="logger" operation="log" xmlns:tns="http://error.logger.technical.jSeduite.modalis.i3s.unice.fr/" portType="tns:ErrorLogger" inputVariable="LogIn" outputVariable="LogOut"/>
                            </sequence>
                        </sequence>
                    </catchAll>
                </faultHandlers>
                <sequence name="internal">
                    <assign name="init_results">
                        <copy>
                                <from>''</from>
                                    <to variable="feed_reader_result"/>
                            </copy>
                    </assign>
                    <sequence name="getCalls">
                        <assign name="getCalls_pre">
                            <copy>
                                <from>'CachedFeedReader'</from>
                                <to>$GetCallIdentifiersIn.parameters/service</to>
                            </copy>
                            <copy>
                                <from>'read'</from>
                                <to>$GetCallIdentifiersIn.parameters/operation</to>
                            </copy>
                            <copy>
                                <from variable="user"/>
                                <to>$GetCallIdentifiersIn.parameters/login</to>
                            </copy>
                        </assign>
                        <invoke name="getCals_tech" partnerLink="preferences" operation="getCallIdentifiers" xmlns:tns="http://preferences.technical.jSeduite.modalis.i3s.unice.fr/" portType="tns:PreferenceManager" inputVariable="GetCallIdentifiersIn" outputVariable="GetCallIdentifiersOut"/>
                    </sequence>
                    <assign name="call_loop_init">
                        <copy>
                            <from>1</from>
                            <to variable="cpt"/>
                        </copy>
                    </assign>
                    <while name="call_loop">
                        <condition>$cpt &lt;= count($GetCallIdentifiersOut.parameters/return)</condition>
                        <sequence name="call_loop_body">
                            <sequence name="getParameter_name">
                                <assign name="getParameter_name_pre">
                                    <copy>
                                        <from>'CachedFeedReader'</from>
                                        <to>$GetParameterValueIn.parameters/service</to>
                                    </copy>
                                    <copy>
                                        <from>'read'</from>
                                        <to>$GetParameterValueIn.parameters/operation</to>
                                    </copy>
                                    <copy>
                                        <from variable="user"/>
                                        <to>$GetParameterValueIn.parameters/login</to>
                                    </copy>
                                    <copy>
                                        <from>'name'</from>
                                        <to>$GetParameterValueIn.parameters/param</to>
                                    </copy>
                                    <copy>
                                        <from>string($GetCallIdentifiersOut.parameters/return[$cpt])</from>
                                        <to>$GetParameterValueIn.parameters/call</to>
                                    </copy>
                                </assign>
                                <invoke name="getParameter_name_tech" partnerLink="preferences" operation="getParameterValue" xmlns:tns="http://preferences.technical.jSeduite.modalis.i3s.unice.fr/" portType="tns:PreferenceManager" inputVariable="GetParameterValueIn" outputVariable="GetParameterValueOut"/>
                                <assign name="getParameter_name_post">
                                    <copy>
                                        <from>$GetParameterValueOut.parameters/return</from>
                                        <to>$CachedFeedReaderOperationIn.in/ns1:name</to>
                                    </copy>
                                </assign>
                            </sequence>
                            <sequence name="getParameter_validity" xmlns:tns="http://preferences.technical.jSeduite.modalis.i3s.unice.fr/">
                                <assign name="getParameter_validity_pre">
                                        <copy>
                                                <from>'CachedFeedReader'</from>
                                                    <to>$GetParameterValueIn.parameters/service</to>
                                            </copy>
                                            <copy>
                                                <from>'read'</from>
                                                    <to>$GetParameterValueIn.parameters/operation</to>
                                            </copy>
                                            <copy>
                                                <from variable="user"/>
                                                    <to>$GetParameterValueIn.parameters/login</to>
                                            </copy>
                                            <copy>
                                                <from>'validity'</from>
                                                    <to>$GetParameterValueIn.parameters/param</to>
                                            </copy>
                                            <copy>
                                                <from>string($GetCallIdentifiersOut.parameters/return[$cpt])</from>
                                                    <to>$GetParameterValueIn.parameters/call</to>
                                            </copy>
                                    </assign>
                                    <invoke name="getParameter_validity_tech" partnerLink="preferences" operation="getParameterValue" xmlns:tns="http://preferences.technical.jSeduite.modalis.i3s.unice.fr/" portType="tns:PreferenceManager" inputVariable="GetParameterValueIn" outputVariable="GetParameterValueOut"/>
                                    <assign name="getParameter_validity_post">
                                        <copy>
                                            <from>number($GetParameterValueOut.parameters/return)</from>
                                            <to>$CachedFeedReaderOperationIn.in/ns1:validity</to>
                                        </copy>
                                    </assign>
                            </sequence>
                            <invoke name="perform_call" partnerLink="feedreader" operation="CachedFeedReaderOperation" xmlns:tns="http://modalis.i3s.unice.fr/jSeduite/wsdl/CachedFeedReader" portType="tns:CachedFeedReaderPortType" inputVariable="CachedFeedReaderOperationIn" outputVariable="CachedFeedReaderOperationOut"/>
                            <assign name="feedLocalResult">
                                <copy>
                                    <from>$CachedFeedReaderOperationOut.out/ns1:return</from>
                                    <to>$feed_reader_result/ns0:item[$cpt]</to>
                                </copy>
                            </assign>
                            <assign name="increment">
                                <copy>
                                    <from>$cpt + 1</from>
                                    <to variable="cpt"/>
                                </copy>
                            </assign>
                        </sequence>
                    </while>
                </sequence>
            </scope>
            <scope name="ICalReader">
                <variables>
                    <variable name="CompareOut" xmlns:tns="http://time.helpers.technical.jSeduite.modails.i3s.unice.fr/" messageType="tns:compareResponse"/>
                    <variable name="CompareIn" xmlns:tns="http://time.helpers.technical.jSeduite.modails.i3s.unice.fr/" messageType="tns:compare"/>
                    <variable name="LogOut" xmlns:tns="http://error.logger.technical.jSeduite.modalis.i3s.unice.fr/" messageType="tns:logResponse"/>
                    <variable name="LogIn" xmlns:tns="http://error.logger.technical.jSeduite.modalis.i3s.unice.fr/" messageType="tns:log"/>
                    <variable name="localCpt" type="xsd:integer"/>
                    <variable name="resultSetLength" type="xsd:integer"/>
                    <variable name="GetTodayOut" xmlns:tns="http://calendar.technical.jSeduite.modalis.i3s.unice.fr/" messageType="tns:getTodayResponse"/>
                    <variable name="GetTodayIn" xmlns:tns="http://calendar.technical.jSeduite.modalis.i3s.unice.fr/" messageType="tns:getToday"/>
                    <variable name="GetParameterValueOut" messageType="ns2:getParameterValueResponse"/>
                    <variable name="GetParameterValueIn" messageType="ns2:getParameterValue"/>
                    <variable name="cpt" type="xsd:integer"/>
                    <variable name="GetCallIdentifiersOut" xmlns:tns="http://preferences.technical.jSeduite.modalis.i3s.unice.fr/" messageType="tns:getCallIdentifiersResponse"/>
                    <variable name="GetCallIdentifiersIn" xmlns:tns="http://preferences.technical.jSeduite.modalis.i3s.unice.fr/" messageType="tns:getCallIdentifiers"/>
                </variables>
                <faultHandlers>
                    <catchAll>
                        <sequence name="onError" xmlns:tns="http://error.logger.technical.jSeduite.modalis.i3s.unice.fr/">
                            <sequence name="log">
                                <assign name="log_pre">
                                    <copy>
                                        <from>'InfoProvider'</from>
                                        <to>$LogIn.parameters/trigger</to>
                                    </copy>
                                    <copy>
                                        <from>'exception'</from>
                                        <to>$LogIn.parameters/level</to>
                                    </copy>
                                    <copy>
                                        <from>'ICalReader Source Exception'</from>
                                        <to>$LogIn.parameters/message</to>
                                    </copy>
                                </assign>
                                <invoke name="log_tech" partnerLink="logger" operation="log" xmlns:tns="http://error.logger.technical.jSeduite.modalis.i3s.unice.fr/" portType="tns:ErrorLogger" inputVariable="LogIn" outputVariable="LogOut"/>
                            </sequence>
                        </sequence>
                    </catchAll>
                </faultHandlers>
                <sequence name="internal">
                    <assign name="init_results">
                        <copy>
                                <from>''</from>
                                    <to variable="ical_result"/>
                            </copy>
                    </assign>
                    <sequence name="getCalls">
                        <assign name="getCalls_pre">
                            <copy>
                                <from>'ICalReader'</from>
                                <to>$GetCallIdentifiersIn.parameters/service</to>
                            </copy>
                                <copy>
                                <from>'getToday'</from>
                                <to>$GetCallIdentifiersIn.parameters/operation</to>
                            </copy>
                                <copy>
                                <from variable="user"/>
                                <to>$GetCallIdentifiersIn.parameters/login</to>
                            </copy>
                        </assign>
                            <invoke name="getCals_tech" partnerLink="preferences" operation="getCallIdentifiers" portType="ns2:PreferenceManager" inputVariable="GetCallIdentifiersIn" outputVariable="GetCallIdentifiersOut"/>
                    </sequence>
                    <assign name="call_loop_init">
                        <copy>
                                <from>1</from>
                                    <to variable="cpt"/>
                            </copy>
                        <copy>
                            <from>1</from>
                            <to variable="resultSetLength"/>
                        </copy>
                    </assign>
                    <while name="call_loop">
                        <condition>$cpt &lt;= count($GetCallIdentifiersOut.parameters/return)</condition>
                        <sequence name="call_loop_body">
                            <sequence name="getParameter_calendar">
                                <assign name="getParameter_calendar_pre">
                                    <copy>
                                        <from>'ICalReader'</from>
                                        <to>$GetParameterValueIn.parameters/service</to>
                                    </copy>
                                    <copy>
                                        <from>'getToday'</from>
                                        <to>$GetParameterValueIn.parameters/operation</to>
                                    </copy>
                                    <copy>
                                        <from variable="user"/>
                                        <to>$GetParameterValueIn.parameters/login</to>
                                    </copy>
                                    <copy>
                                        <from>'calendar'</from>
                                        <to>$GetParameterValueIn.parameters/param</to>
                                    </copy>
                                    <copy>
                                        <from>string($GetCallIdentifiersOut.parameters/return[$cpt])</from>
                                        <to>$GetParameterValueIn.parameters/call</to>
                                    </copy>
                                </assign>
                                <invoke name="getParameter_calendar_tech" partnerLink="preferences" operation="getParameterValue" portType="ns2:PreferenceManager" inputVariable="GetParameterValueIn" outputVariable="GetParameterValueOut"/>
                                <assign name="getParameter_calendar_post">
                                    <copy>
                                        <from>$GetParameterValueOut.parameters/return</from>
                                        <to>$GetTodayIn.parameters/calendar</to>
                                    </copy>
                                </assign>
                            </sequence>
                            <invoke name="perform_call" partnerLink="iCal" operation="getToday" xmlns:tns="http://calendar.technical.jSeduite.modalis.i3s.unice.fr/" portType="tns:ICalReader" inputVariable="GetTodayIn" outputVariable="GetTodayOut"/>
                            <sequence name="feedLocalResult">
                                <assign name="feed_loop_pre">
                                    <copy>
                                        <from>1</from>
                                        <to variable="localCpt"/>
                                    </copy>
                                </assign>
                                <while name="feed_loop">
                                    <condition>$localCpt &lt;= count($GetTodayOut.parameters/return)</condition>
                                    <sequence name="feed_loop_body">
                                        <sequence name="shouldFilter">
                                            <assign name="time_pre">
                                                <copy>
                                                    <from>$GetTodayOut.parameters/return[$localCpt]/end</from>
                                                    <to>$CompareIn.parameters/d1</to>
                                                </copy>
                                                <copy>
                                                    <from>sxxf:current-dateTime()</from>
                                                    <to>$CompareIn.parameters/d2</to>
                                                </copy>
                                            </assign>
                                            <invoke name="time_tech" partnerLink="time" operation="compare" xmlns:tns="http://time.helpers.technical.jSeduite.modails.i3s.unice.fr/" portType="tns:TimeMachine" inputVariable="CompareIn" outputVariable="CompareOut"/>
                                        </sequence>
                                        <if name="filter">
                                            <condition>$CompareOut.parameters/return &gt;= 0</condition>
                                            <sequence name="feeding">
                                                <assign name="feed">
                                                    <copy>
                                                            <from>$GetTodayOut.parameters/return[$localCpt]</from>
                                                                <to>$ical_result/ns0:item[$resultSetLength]</to>
                                                        </copy>
                                                </assign>
                                                <assign name="globalLength">
                                                    <copy>
                                                        <from>$resultSetLength + 1</from>
                                                        <to variable="resultSetLength"/>
                                                    </copy>
                                                </assign>
                                            </sequence>
                                            <else>
                                                <empty name="nop"/>
                                            </else>
                                        </if>
                                        <assign name="increment_feed">
                                            <copy>
                                                <from>$localCpt + 1</from>
                                                <to variable="localCpt"/>
                                            </copy>
                                        </assign>
                                    </sequence>
                                </while>
                            </sequence>
                            <assign name="increment">
                                <copy>
                                        <from>$cpt + 1</from>
                                            <to variable="cpt"/>
                                    </copy>
                            </assign>
                        </sequence>
                    </while>
                </sequence>
            </scope>
            <scope name="TvShows">
                <variables>
                    <variable name="LogOut" xmlns:tns="http://error.logger.technical.jSeduite.modalis.i3s.unice.fr/" messageType="tns:logResponse"/>
                    <variable name="LogIn" xmlns:tns="http://error.logger.technical.jSeduite.modalis.i3s.unice.fr/" messageType="tns:log"/>
                    <variable name="TvShowsOperationOut" xmlns:tns="http://modalis.i3s.unice.fr/jSeduite/wsdl/TvShows" messageType="tns:TvShowsOperationResponse"/>
                    <variable name="TvShowsOperationIn" xmlns:tns="http://modalis.i3s.unice.fr/jSeduite/wsdl/TvShows" messageType="tns:TvShowsOperationRequest"/>
                    <variable name="GetCallIdentifiersOut" messageType="ns2:getCallIdentifiersResponse"/>
                    <variable name="GetCallIdentifiersIn" messageType="ns2:getCallIdentifiers"/>
                </variables>
                <faultHandlers>
                    <catchAll>
                        <sequence name="onError" xmlns:tns="http://error.logger.technical.jSeduite.modalis.i3s.unice.fr/">
                            <sequence name="log">
                                <assign name="log_pre">
                                    <copy>
                                        <from>'InfoProvider'</from>
                                        <to>$LogIn.parameters/trigger</to>
                                    </copy>
                                    <copy>
                                        <from>'exception'</from>
                                        <to>$LogIn.parameters/level</to>
                                    </copy>
                                    <copy>
                                        <from>'TvShows Source Exception'</from>
                                        <to>$LogIn.parameters/message</to>
                                    </copy>
                                </assign>
                                <invoke name="log_tech" partnerLink="logger" operation="log" xmlns:tns="http://error.logger.technical.jSeduite.modalis.i3s.unice.fr/" portType="tns:ErrorLogger" inputVariable="LogIn" outputVariable="LogOut"/>
                            </sequence>
                        </sequence>
                    </catchAll>
                </faultHandlers>
                <sequence name="internal">
                    <assign name="init_results">
                        <copy>
                            <from>''</from>
                            <to variable="tvShows"/>
                        </copy>
                    </assign>
                    <sequence name="getCalls">
                        <assign name="getCalls_pre">
                            <copy>
                                <from>'TvShows'</from>
                                <to>$GetCallIdentifiersIn.parameters/service</to>
                            </copy>
                                <copy>
                                <from>'get'</from>
                                <to>$GetCallIdentifiersIn.parameters/operation</to>
                            </copy>
                                <copy>
                                <from variable="user"/>
                                <to>$GetCallIdentifiersIn.parameters/login</to>
                            </copy>
                        </assign>
                            <invoke name="getCals_tech" partnerLink="preferences" operation="getCallIdentifiers" portType="ns2:PreferenceManager" inputVariable="GetCallIdentifiersIn" outputVariable="GetCallIdentifiersOut"/>
                    </sequence>
                    <if name="shouldCall">
                        <condition>1 = count($GetCallIdentifiersOut.parameters/return)</condition>
                        <sequence name="perform_call">
                            <assign name="call_pre">
                                <copy>
                                    <from>''</from>
                                    <to variable="TvShowsOperationIn" part="in"/>
                                </copy>
                            </assign>
                            <invoke name="call_tech" partnerLink="tv" operation="TvShowsOperation" xmlns:tns="http://modalis.i3s.unice.fr/jSeduite/wsdl/TvShows" portType="tns:TvShowsPortType" inputVariable="TvShowsOperationIn" outputVariable="TvShowsOperationOut"/>
                            <assign name="call_post">
                                <copy>
                                    <from>$TvShowsOperationOut.out/ns4:show</from>
                                    <to>$tvShows/ns0:item</to>
                                </copy>
                            </assign>
                        </sequence>
                        <else>
                            <empty name="nop"/>
                        </else>
                    </if>
                </sequence>
            </scope>
        </flow>
        <sequence name="feed_result">
            <assign name="init">
                <copy>
                    <from>''</from>
                    <to variable="result"/>
                </copy>
                <copy>
                    <from>1</from>
                    <to variable="globalIndex"/>
                </copy>
            </assign>
            <scope name="CachedFeedReader_Feed">
                <variables>
                    <variable name="cpt" type="xsd:integer"/>
                </variables>
                <sequence name="internal">
                    <assign name="init">
                        <copy>
                            <from>1</from>
                            <to variable="cpt"/>
                        </copy>
                    </assign>
                        <while name="feed_loop">
                            <condition>$cpt &lt;= count($feed_reader_result/ns0:item)</condition>
                                <sequence name="feed_loop_body">
                                    <assign name="feed_result">
                                        <copy>
                                            <from>$feed_reader_result/ns0:item[$cpt]</from>
                                            <to>$result/ns0:item[$globalIndex]/ns0:feedContent</to>
                                        </copy>
                                        <copy>
                                            <from>'feedContent'</from>
                                            <to>$result/ns0:item[$globalIndex]/@kind</to>
                                        </copy>
                                    </assign>
                                        <assign name="increment">
                                            <copy>
                                                <from>$globalIndex + 1</from>
                                                <to variable="globalIndex"/>
                                            </copy>
                                            <copy>
                                                <from>$cpt + 1</from>
                                                <to variable="cpt"/>
                                            </copy>
                                        </assign>
                                </sequence>
                        </while>
                </sequence>
            </scope>
            <scope name="ICalReader_Feed">
                <variables>
                    <variable name="cpt" type="xsd:integer"/>
                </variables>
                <sequence name="internal">
                    <assign name="init">
                        <copy>
                            <from>1</from>
                            <to variable="cpt"/>
                        </copy>
                    </assign>
                        <while name="feed_loop">
                            <condition>$cpt &lt;= count($ical_result/ns0:item)</condition>
                                <sequence name="feed_loop_body">
                                    <assign name="feed_result">
                                        <copy>
                                            <from>'calendarEvent'</from>
                                            <to>$result/ns0:item[$globalIndex]/@kind</to>
                                        </copy>
                                        <copy>
                                            <from>$ical_result/ns0:item[$cpt]</from>
                                            <to>$result/ns0:item[$globalIndex]/ns0:calendarEvent</to>
                                        </copy>
                                    </assign>
                                        <assign name="increment">
                                            <copy>
                                                <from>$globalIndex + 1</from>
                                                <to variable="globalIndex"/>
                                            </copy>
                                            <copy>
                                                <from>$cpt + 1</from>
                                                <to variable="cpt"/>
                                            </copy>
                                        </assign>
                                </sequence>
                        </while>
                </sequence>
            </scope>
            <scope name="TvShows_Feed">
                <sequence name="internal">
                    <if name="shouldAdd">
                        <condition>count($tvShows/ns0:item) &gt; 0</condition>
                        <sequence name="Sequence1">
                            <assign name="feed">
                                <copy>
                                    <from variable="tvShows"/>
                                    <to>$result/ns0:item/ns0:ShowSet</to>
                                </copy>
                                <copy>
                                    <from>'ShowSet'</from>
                                    <to>$result/ns0:item/@kind</to>
                                </copy>
                            </assign>
                            <assign name="increment">
                                <copy>
                                    <from>$globalIndex + 1</from>
                                    <to variable="globalIndex"/>
                                </copy>
                            </assign>
                        </sequence>
                        <else>
                            <empty name="nop"/>
                        </else>
                    </if>
                </sequence>
            </scope>
        </sequence>
        <sequence name="response">
            <assign name="collect_result">
                <copy>
                    <from variable="result"/>
                    <to>$GetInformationOut.out/ns0:result</to>
                </copy>
            </assign>
            <reply name="reply" partnerLink="external" operation="GetInformation" xmlns:tns="http://modalis.polytech.unice.fr/jSeduite/wsdl/InfoProvider/epu" portType="tns:InfoProviderPortType" variable="GetInformationOut"/>
        </sequence>
    </sequence>
</process>
