<?xml version="1.0" encoding="UTF-8"?>
<process
    name="ImageScrapper"
    targetNamespace="http://modalis.i3s.unice.fr/jSeduite/bpel/ImageScrapper"
    xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema"
    xmlns:sxt="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Trace" 
    xmlns:sxed="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Editor"
    xmlns:tns="http://modalis.i3s.unice.fr/jSeduite/bpel/ImageScrapper" xmlns:ns0="http://modalis.i3s.unice.fr/jSeduite/schema/ImageScapper" xmlns:ns1="http://picasa.image.technical.jSeduite.modalis.i3s.unice.fr/" xmlns:ns2="http://flickr.image.technical.jSeduite.modalis.i3s.unice.fr/" xmlns:sxxf="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/XPathFunctions" xmlns:ns3="http://helper.image.technical.jSeduite.modalis.i3s.unice.fr/" xmlns:ns4="http://docs.oasis-open.org/wsbpel/2.0/process/executable">
    <import namespace="http://modalis.i3s.unice.fr/jSeduite/wsdl/ImageScrapper" location="ImageScrapper.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://enterprise.netbeans.org/bpel/PicasaWrapperServiceWrapper" location="Partners/localhost_8080/jSeduite/PicasaWrapper/PicasaWrapperServiceWrapper.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://picasa.image.technical.jSeduite.modalis.i3s.unice.fr/" location="Partners/localhost_8080/jSeduite/PicasaWrapper/PicasaWrapperService.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://enterprise.netbeans.org/bpel/FlickrWrapperServiceWrapper" location="Partners/localhost_8080/jSeduite/FlickrWrapper/FlickrWrapperServiceWrapper.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://flickr.image.technical.jSeduite.modalis.i3s.unice.fr/" location="Partners/localhost_8080/jSeduite/FlickrWrapper/FlickrWrapperService.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://enterprise.netbeans.org/bpel/PictureSetServiceWrapper" location="Partners/localhost_8080/jSeduite/PictureSet/PictureSetServiceWrapper.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://helper.image.technical.jSeduite.modalis.i3s.unice.fr/" location="Partners/localhost_8080/jSeduite/PictureSet/PictureSetService.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://modalis.i3s.unice.fr/jSeduite/schema/ImageScapper" location="ImageScapper.xsd" importType="http://www.w3.org/2001/XMLSchema"/>
    <partnerLinks>
        <partnerLink name="picasa" xmlns:tns="http://enterprise.netbeans.org/bpel/PicasaWrapperServiceWrapper" partnerLinkType="tns:PicasaWrapperLinkType" partnerRole="picasa"/>
        <partnerLink name="flickr" xmlns:tns="http://enterprise.netbeans.org/bpel/FlickrWrapperServiceWrapper" partnerLinkType="tns:FlickrWrapperLinkType" partnerRole="flickr"/>
        <partnerLink name="helper" xmlns:tns="http://enterprise.netbeans.org/bpel/PictureSetServiceWrapper" partnerLinkType="tns:PictureSetLinkType" partnerRole="helper"/>
        <partnerLink name="external" xmlns:tns="http://modalis.i3s.unice.fr/jSeduite/wsdl/ImageScrapper" partnerLinkType="tns:ImageScrapper" myRole="ImageScrapperPortTypeRole"/>
    </partnerLinks>
    <variables>
        <variable name="truncated" type="ns0:ArrayOfURL"/>
        <variable name="TruncateOut" xmlns:tns="http://helper.image.technical.jSeduite.modalis.i3s.unice.fr/" messageType="tns:truncateResponse"/>
        <variable name="TruncateIn" xmlns:tns="http://helper.image.technical.jSeduite.modalis.i3s.unice.fr/" messageType="tns:truncate"/>
        <variable name="ShuffleOut" xmlns:tns="http://helper.image.technical.jSeduite.modalis.i3s.unice.fr/" messageType="tns:shuffleResponse"/>
        <variable name="ShuffleIn" xmlns:tns="http://helper.image.technical.jSeduite.modalis.i3s.unice.fr/" messageType="tns:shuffle"/>
        <variable name="shuffled" type="ns0:ArrayOfURL"/>
        <variable name="merged" type="ns0:ArrayOfURL"/>
        <variable name="MergeOut" xmlns:tns="http://helper.image.technical.jSeduite.modalis.i3s.unice.fr/" messageType="tns:mergeResponse"/>
        <variable name="MergeIn" xmlns:tns="http://helper.image.technical.jSeduite.modalis.i3s.unice.fr/" messageType="tns:merge"/>
        <variable name="flickrSet" type="ns0:ArrayOfURL"/>
        <variable name="GetFlickrFolksonomyContentOut" xmlns:tns="http://flickr.image.technical.jSeduite.modalis.i3s.unice.fr/" messageType="tns:getFolksonomyContentResponse"/>
        <variable name="GetFlickrFolksonomyContentIn" xmlns:tns="http://flickr.image.technical.jSeduite.modalis.i3s.unice.fr/" messageType="tns:getFolksonomyContent"/>
        <variable name="picasaSet" type="ns0:ArrayOfURL"/>
        <variable name="GetPicasaFolksonomyContentOut" xmlns:tns="http://picasa.image.technical.jSeduite.modalis.i3s.unice.fr/" messageType="tns:getFolksonomyContentResponse"/>
        <variable name="GetPicasaFolksonomyContentIn" xmlns:tns="http://picasa.image.technical.jSeduite.modalis.i3s.unice.fr/" messageType="tns:getFolksonomyContent"/>
        <variable name="size" type="xsd:int"/>
        <variable name="tags" type="xsd:string"/>
        <variable name="ImageScrapperOperationOut" xmlns:tns="http://modalis.i3s.unice.fr/jSeduite/wsdl/ImageScrapper" messageType="tns:ImageScrapperOperationResponse"/>
        <variable name="ImageScrapperOperationIn" xmlns:tns="http://modalis.i3s.unice.fr/jSeduite/wsdl/ImageScrapper" messageType="tns:ImageScrapperOperationRequest"/>
    </variables>
    <sequence>
        <sequence name="a1">
            <receive name="a1_tech" createInstance="yes" partnerLink="external" operation="ImageScrapperOperation" xmlns:tns="http://modalis.i3s.unice.fr/jSeduite/wsdl/ImageScrapper" portType="tns:ImageScrapperPortType" variable="ImageScrapperOperationIn"/>
            <assign name="a1_post">
                <copy>
                    <from>$ImageScrapperOperationIn.in/ns0:tags</from>
                    <to variable="tags"/>
                </copy>
                <copy>
                    <from>$ImageScrapperOperationIn.in/ns0:size</from>
                    <to variable="size"/>
                </copy>
            </assign>
        </sequence>
        <flow name="do_in_parallel">
            <scope name="a02_scope">
                <faultHandlers>
                    <catchAll>
                        <assign name="a02_error">
                            <copy>
                                <from>''</from>
                                <to>$picasaSet/ns0:item</to>
                            </copy>
                        </assign>
                    </catchAll>
                </faultHandlers>
                <sequence name="a02">
                    <assign name="a02_pre">
                            <copy>
                                    <from variable="tags"/>
                                        <to>$GetPicasaFolksonomyContentIn.parameters/query</to>
                                </copy>
                                <copy>
                                    <from variable="size"/>
                                        <to>$GetPicasaFolksonomyContentIn.parameters/count</to>
                                </copy>
                        </assign>
                        <invoke name="a02_tech" partnerLink="picasa" operation="getFolksonomyContent" portType="ns1:PicasaWrapper" inputVariable="GetPicasaFolksonomyContentIn" outputVariable="GetPicasaFolksonomyContentOut"/>
                        <assign name="a02_post">
                            <copy>
                                    <from>$GetPicasaFolksonomyContentOut.parameters/return</from>
                                        <to>$picasaSet/ns0:item</to>
                                </copy>
                        </assign>
                </sequence>
            </scope>
            <scope name="a12_scope">
                <faultHandlers>
                    <catchAll>
                        <assign name="a12_error">
                            <copy>
                                <from>''</from>
                                <to>$flickrSet/ns0:item</to>
                            </copy>
                        </assign>
                    </catchAll>
                </faultHandlers>
                <sequence name="a12">
                    <assign name="a12_pre">
                            <copy>
                                    <from variable="tags"/>
                                        <to>$GetFlickrFolksonomyContentIn.parameters/tags</to>
                                </copy>
                                <copy>
                                    <from variable="size"/>
                                        <to>$GetFlickrFolksonomyContentIn.parameters/count</to>
                                </copy>
                        </assign>
                        <invoke name="a12_tech" partnerLink="flickr" operation="getFolksonomyContent" portType="ns2:FlickrWrapper" inputVariable="GetFlickrFolksonomyContentIn" outputVariable="GetFlickrFolksonomyContentOut"/>
                        <assign name="a12_post">
                            <copy>
                                    <from>$GetFlickrFolksonomyContentOut.parameters/return</from>
                                        <to>$flickrSet/ns0:item</to>
                                </copy>
                        </assign>
                </sequence>
            </scope>
        </flow>
        <scope name="a3_scope">
            <faultHandlers>
                <catchAll>
                    <sequence name="a3_error">
                        <assign name="a3_err_pre">
                            <copy>
                                    <from>''</from>
                                        <to variable="ImageScrapperOperationOut" part="out"/>
                                </copy>
                        </assign>
                        <reply name="a3_err_tech" partnerLink="external" operation="ImageScrapperOperation" xmlns:tns="http://modalis.i3s.unice.fr/jSeduite/wsdl/ImageScrapper" portType="tns:ImageScrapperPortType" variable="ImageScrapperOperationOut"/>
                        <exit name="a3_exit"/>
                    </sequence>
                </catchAll>
            </faultHandlers>
            <sequence name="a3">
                <assign name="a3_pre">
                        <copy>
                                <from>$flickrSet/ns0:item</from>
                                    <to>$MergeIn.parameters/first</to>
                            </copy>
                            <copy>
                                <from>$picasaSet/ns0:item</from>
                                    <to>$MergeIn.parameters/second</to>
                            </copy>
                    </assign>
                    <invoke name="a3_tech" partnerLink="helper" operation="merge" portType="ns3:PictureSet" inputVariable="MergeIn" outputVariable="MergeOut"/>
                    <assign name="a3_post">
                        <copy>
                                <from>$MergeOut.parameters/return</from>
                                    <to>$merged/ns0:item</to>
                            </copy>
                    </assign>
            </sequence>
        </scope>
        <sequence name="a4">
            <assign name="a4_pre">
                <copy>
                    <from>$merged/ns0:item</from>
                    <to>$ShuffleIn.parameters/set</to>
                </copy>
            </assign>
            <invoke name="a4_tech" partnerLink="helper" operation="shuffle" xmlns:tns="http://helper.image.technical.jSeduite.modalis.i3s.unice.fr/" portType="tns:PictureSet" inputVariable="ShuffleIn" outputVariable="ShuffleOut"/>
            <assign name="a4_post">
                <copy>
                    <from>$ShuffleOut.parameters/return</from>
                    <to>$shuffled/ns0:item</to>
                </copy>
            </assign>
        </sequence>
        <sequence name="a5">
            <assign name="a5_pre">
                <copy>
                    <from variable="size"/>
                    <to>$TruncateIn.parameters/count</to>
                </copy>
                <copy>
                    <from>$shuffled/ns0:item</from>
                    <to>$TruncateIn.parameters/set</to>
                </copy>
            </assign>
            <invoke name="a5_tech" partnerLink="helper" operation="truncate" xmlns:tns="http://helper.image.technical.jSeduite.modalis.i3s.unice.fr/" portType="tns:PictureSet" inputVariable="TruncateIn" outputVariable="TruncateOut"/>
            <assign name="a5_post">
                <copy>
                    <from>$TruncateOut.parameters/return</from>
                    <to>$truncated/ns0:item</to>
                </copy>
            </assign>
        </sequence>
        <sequence name="a6">
            <assign name="a6_pre">
                <copy>
                    <from>$truncated/ns0:item</from>
                    <to>$ImageScrapperOperationOut.out/ns0:url</to>
                </copy>
            </assign>
            <reply name="a6_tech" partnerLink="external" operation="ImageScrapperOperation" xmlns:tns="http://modalis.i3s.unice.fr/jSeduite/wsdl/ImageScrapper" portType="tns:ImageScrapperPortType" variable="ImageScrapperOperationOut"/>
        </sequence>
    </sequence>
</process>
